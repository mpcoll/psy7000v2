

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Modeling Single Subject Data &#8212; StatsPsy</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'content/GLM_Single_Subject_Model';</script>
    <link rel="canonical" href="http://www.mpcoll.github.io/psy7000v2/content/GLM_Single_Subject_Model.html" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    <p class="title logo__title">StatsPsy</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Aperçu et instructions</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="Instructors.html">Enseignants</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="Signal_Processing.html">Signal Processing Basics</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">PSY-7000 Analyses de plan d'expérience</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="cours3_land.html">Cour 3 - Modélisation</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="Cours3.html">Notes et exercices</a></li>

</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/mpcoll/psy7000v2/blob/master/content/GLM_Single_Subject_Model.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/mpcoll/psy7000v2" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/mpcoll/psy7000v2/edit/master/content/GLM_Single_Subject_Model.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/mpcoll/psy7000v2/issues/new?title=Issue%20on%20page%20%2Fcontent/GLM_Single_Subject_Model.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/content/GLM_Single_Subject_Model.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Modeling Single Subject Data</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dataset">Dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#building-a-design-matrix">Building a Design Matrix</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hrf-convolution">HRF Convolution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multicollinearity">Multicollinearity</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#variance-inflation-factor">Variance Inflation Factor</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#orthogonalization">Orthogonalization</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nuisance-variables">Nuisance Variables</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#filtering">Filtering</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#intercepts">Intercepts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#linear-trends">Linear Trends</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#noise-covariates">Noise Covariates</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#smoothing">Smoothing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#estimate-glm-for-all-voxels">Estimate GLM for all voxels</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#save-image">Save Image</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#contrasts">Contrasts</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#which-regions-are-more-involved-with-visual-compared-to-auditory-sensory-processing">1. Which regions are more involved with visual compared to auditory sensory processing?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#which-regions-are-more-involved-in-processing-numbers-compared-to-words">2. Which regions are more involved in processing numbers compared to words?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#which-regions-are-more-involved-with-motor-compared-to-cognitive-processes-e-g-language-and-math">3. Which regions are more involved with motor compared to cognitive processes (e.g., language and math)?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-are-your-results-impacted-by-different-smoothing-kernels">4. How are your results impacted by different smoothing kernels?</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="modeling-single-subject-data">
<h1>Modeling Single Subject Data<a class="headerlink" href="#modeling-single-subject-data" title="Permalink to this heading">#</a></h1>
<p><em>Written by Luke Chang</em></p>
<p>Now that we have learned the basics of the GLM using simulations, it’s time to apply this to working with real data. The first step in fMRI data analysis is to build a model for each subject to predict the activation in a single voxel over the entire scanning session. To do this, we need to build a design matrix for our general linear model. We expect distinct brain regions to be involved in processing specific aspects of our task. This means that we will construct separate regressors that model different brain processes.</p>
<p>In this tutorial, we will learn how to build and estimate a single subject first-level model and will cover the following topics:</p>
<ul class="simple">
<li><p>Building a design matrix</p></li>
<li><p>Modeling noise in the GLM with nuisance variables</p></li>
<li><p>Estimating GLM</p></li>
<li><p>Performing basic contrasts</p></li>
</ul>
<section id="dataset">
<h2>Dataset<a class="headerlink" href="#dataset" title="Permalink to this heading">#</a></h2>
<p>We will continue to work with the Pinel Localizer dataset from our preprocessing examples.</p>
<p>The Pinel Localizer task was designed to probe several different types of basic cognitive processes, such as visual perception, finger tapping, language, and math. Several of the tasks are cued by reading text on the screen (i.e., visual modality) and also by hearing auditory instructions (i.e., auditory modality). The trials are randomized across conditions and have been optimized to maximize efficiency for a rapid event related design. There are 100 trials in total over a 5-minute scanning session. Read the original <a class="reference external" href="https://bmcneurosci.biomedcentral.com/articles/10.1186/1471-2202-8-91">paper</a> for more specific details about the task and the <a class="reference external" href="https://doi.org/10.1016/j.neuroimage.2015.09.052">dataset paper</a>.</p>
<p>This dataset is well suited for these tutorials as it is (a) publicly available to anyone in the world, (b) relatively small (only about 5min), and (c) provides many options to create different types of contrasts.</p>
<p>There are a total of 94 subjects available, but we will primarily only be working with a smaller subset of 10-20 participants. See our tutorial on how to download the data if you are not taking the Psych60 version of the class.</p>
</section>
<section id="building-a-design-matrix">
<h2>Building a Design Matrix<a class="headerlink" href="#building-a-design-matrix" title="Permalink to this heading">#</a></h2>
<p>First, we will learn the basics of how to build a design matrix for our GLM.</p>
<p>Let’s load all of the python modules we will need to complete this tutorial.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
<span class="kn">from</span> <span class="nn">nltools.file_reader</span> <span class="kn">import</span> <span class="n">onsets_to_dm</span>
<span class="kn">from</span> <span class="nn">nltools.stats</span> <span class="kn">import</span> <span class="n">regress</span><span class="p">,</span> <span class="n">zscore</span>
<span class="kn">from</span> <span class="nn">nltools.data</span> <span class="kn">import</span> <span class="n">Brain_Data</span><span class="p">,</span> <span class="n">Design_Matrix</span>
<span class="kn">from</span> <span class="nn">nltools.stats</span> <span class="kn">import</span> <span class="n">find_spikes</span> 
<span class="kn">from</span> <span class="nn">nilearn.plotting</span> <span class="kn">import</span> <span class="n">view_img</span><span class="p">,</span> <span class="n">glass_brain</span><span class="p">,</span> <span class="n">plot_stat_map</span>
<span class="kn">from</span> <span class="nn">bids</span> <span class="kn">import</span> <span class="n">BIDSLayout</span><span class="p">,</span> <span class="n">BIDSValidator</span>

<span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;../data/localizer&#39;</span>
<span class="n">layout</span> <span class="o">=</span> <span class="n">BIDSLayout</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">derivatives</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/lukechang/anaconda3/lib/python3.7/site-packages/sklearn/utils/deprecation.py:144: FutureWarning: The sklearn.linear_model.base module is  deprecated in version 0.22 and will be removed in version 0.24. The corresponding classes / functions should instead be imported from sklearn.linear_model. Anything that cannot be imported from sklearn.linear_model is now part of the private API.
  warnings.warn(message, FutureWarning)
</pre></div>
</div>
</div>
</div>
<p>To build the design matrix, we will be using the Design_Matrix class from the nltools toolbox.  First, we use pandas to load the text file that contains the onset and duration for each condition of the task. Rows reflect measurements in time sampled at 1/tr cycles per second. Columns reflect distinct conditions. Conditions are either on or off. We then cast this Pandas DataFrame as a Design_Matrix object. Be sure to specify the sampling frequency, which is <span class="math notranslate nohighlight">\(\frac{1}{tr}\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load_bids_events</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">subject</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Create a design_matrix instance from BIDS event file&#39;&#39;&#39;</span>
    
    <span class="n">tr</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">get_tr</span><span class="p">()</span>
    <span class="n">n_tr</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s1">&#39;raw&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">onsets</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;events&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">onsets</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Onset&#39;</span><span class="p">,</span> <span class="s1">&#39;Duration&#39;</span><span class="p">,</span> <span class="s1">&#39;Stim&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">onsets_to_dm</span><span class="p">(</span><span class="n">onsets</span><span class="p">,</span> <span class="n">sampling_freq</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">tr</span><span class="p">,</span> <span class="n">run_length</span><span class="o">=</span><span class="n">n_tr</span><span class="p">)</span>

<span class="n">dm</span> <span class="o">=</span> <span class="n">load_bids_events</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="s1">&#39;S01&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/lukechang/anaconda3/lib/python3.7/site-packages/nltools-0.3.18-py3.7.egg/nltools/file_reader.py:141: UserWarning: Computed onsets for video_right_hand are inconsistent with expected values. Please manually verify the outputted Design_Matrix!
  f&quot;Computed onsets for {data.Stim.unique()[i]} are inconsistent with expected values. Please manually verify the outputted Design_Matrix!&quot;
/Users/lukechang/anaconda3/lib/python3.7/site-packages/nltools-0.3.18-py3.7.egg/nltools/file_reader.py:141: UserWarning: Computed onsets for video_left_hand are inconsistent with expected values. Please manually verify the outputted Design_Matrix!
  f&quot;Computed onsets for {data.Stim.unique()[i]} are inconsistent with expected values. Please manually verify the outputted Design_Matrix!&quot;
/Users/lukechang/anaconda3/lib/python3.7/site-packages/nltools-0.3.18-py3.7.egg/nltools/file_reader.py:141: UserWarning: Computed onsets for audio_computation are inconsistent with expected values. Please manually verify the outputted Design_Matrix!
  f&quot;Computed onsets for {data.Stim.unique()[i]} are inconsistent with expected values. Please manually verify the outputted Design_Matrix!&quot;
</pre></div>
</div>
</div>
</div>
<p>The Design_Matrix class is built on top of Pandas DataFrames and retains most of that functionality. There are additional methods to help with building design matrices. Be sure to check out this <a class="reference external" href="https://nltools.org/auto_examples/01_DataOperations/plot_design_matrix.html#sphx-glr-auto-examples-01-dataoperations-plot-design-matrix-py">tutorial</a> for more information about how to use this tool.</p>
<p>We can check out details about the data using the <code class="docutils literal notranslate"><span class="pre">.info()</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dm</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;nltools.data.design_matrix.Design_Matrix&#39;&gt;
RangeIndex: 128 entries, 0 to 127
Data columns (total 10 columns):
 #   Column                   Non-Null Count  Dtype  
---  ------                   --------------  -----  
 0   video_computation        128 non-null    float64
 1   horizontal_checkerboard  128 non-null    float64
 2   audio_right_hand         128 non-null    float64
 3   audio_sentence           128 non-null    float64
 4   video_right_hand         128 non-null    float64
 5   audio_left_hand          128 non-null    float64
 6   video_left_hand          128 non-null    float64
 7   vertical_checkerboard    128 non-null    float64
 8   audio_computation        128 non-null    float64
 9   video_sentence           128 non-null    float64
dtypes: float64(10)
memory usage: 10.1 KB
</pre></div>
</div>
</div>
</div>
<p>We can also view the raw design matrix as a dataframe just like pd.Dataframe.  We use the <code class="docutils literal notranslate"><span class="pre">.head()</span></code> method to just post the first few rows.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dm</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>video_computation</th>
      <th>horizontal_checkerboard</th>
      <th>audio_right_hand</th>
      <th>audio_sentence</th>
      <th>video_right_hand</th>
      <th>audio_left_hand</th>
      <th>video_left_hand</th>
      <th>vertical_checkerboard</th>
      <th>audio_computation</th>
      <th>video_sentence</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can plot each regressor’s time course using the <code class="docutils literal notranslate"><span class="pre">.plot()</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">,</span><span class="n">a</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">dm</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7fb700ed4110&gt;
</pre></div>
</div>
<img alt="../_images/65de6fbeb8f430f9615b72ceac98204765844d2dd3f99a9393d1ecbaa1821eab.png" src="../_images/65de6fbeb8f430f9615b72ceac98204765844d2dd3f99a9393d1ecbaa1821eab.png" />
</div>
</div>
<p>This plot can be useful sometimes, but here there are too many regressors, which makes it difficult to see what is going on.</p>
<p>Often,  <code class="docutils literal notranslate"><span class="pre">.heatmap()</span></code> method provides a more useful visual representation of the design matrix.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dm</span><span class="o">.</span><span class="n">heatmap</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b3ac89367582cee88d47e60b16258234d7bc480da7f60c3aa85892e4ab14840c.png" src="../_images/b3ac89367582cee88d47e60b16258234d7bc480da7f60c3aa85892e4ab14840c.png" />
</div>
</div>
<section id="hrf-convolution">
<h3>HRF Convolution<a class="headerlink" href="#hrf-convolution" title="Permalink to this heading">#</a></h3>
<p>Recall what we learned about convolution in our signal processing tutorial. We can now convolve all of the onset regressors with an HRF function using the <code class="docutils literal notranslate"><span class="pre">.convolve()</span></code> method. By default it will convolve all regressors with the standard double gamma HRF function, though you can specify custom ones and also specific regressors to convolve. Check out the docstrings for more information by adding a <code class="docutils literal notranslate"><span class="pre">?</span></code> after the function name. If you are interested in learning more about different ways to model the HRF using temporal basis functions, watch this <a class="reference external" href="https://www.youtube.com/watch?v=YfeMIcDWwko&amp;t=9s">video</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dm_conv</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">convolve</span><span class="p">()</span>
<span class="n">dm_conv</span><span class="o">.</span><span class="n">heatmap</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/cf7bcadeba1070b2cdaca7586ab05c83ae01c81b51d55f464ae7c9da8ea42909.png" src="../_images/cf7bcadeba1070b2cdaca7586ab05c83ae01c81b51d55f464ae7c9da8ea42909.png" />
</div>
</div>
<p>You can see that each of the regressors is now  bit blurrier and now has the shape of an HRF function. We can plot a single regoressor to see this more clearly using the <code class="docutils literal notranslate"><span class="pre">.plot()</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">,</span><span class="n">a</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">dm_conv</span><span class="p">[</span><span class="s1">&#39;horizontal_checkerboard_c0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7fb69091c990&gt;
</pre></div>
</div>
<img alt="../_images/501221c2a58898eec6a301425eb01f734379fe8b84d090546e380eec8f345fcf.png" src="../_images/501221c2a58898eec6a301425eb01f734379fe8b84d090546e380eec8f345fcf.png" />
</div>
</div>
<p>Maybe we want to plot both of the checkerboard regressors.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">,</span><span class="n">a</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">dm_conv</span><span class="p">[[</span><span class="s1">&#39;horizontal_checkerboard_c0&#39;</span><span class="p">,</span><span class="s1">&#39;vertical_checkerboard_c0&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7fb690964c90&gt;
</pre></div>
</div>
<img alt="../_images/5b9c405bbfca1c7ba309f25bb646e72532b5d55529b65976eff6d005dff964db.png" src="../_images/5b9c405bbfca1c7ba309f25bb646e72532b5d55529b65976eff6d005dff964db.png" />
</div>
</div>
</section>
<section id="multicollinearity">
<h3>Multicollinearity<a class="headerlink" href="#multicollinearity" title="Permalink to this heading">#</a></h3>
<p>In statistics, collinearity or multicollinearity is when one regressor can be strongly linearly predicted from the others. While this does not actually impact the model’s ability to predict data as a whole, it will impact our ability to accurately attribute variance to a single regressor. Recall that in multiple regression, we are estimating the independent variance from each regressor from <code class="docutils literal notranslate"><span class="pre">X</span></code> on <code class="docutils literal notranslate"><span class="pre">Y</span></code>. If there is substantial overlap between the regressors, then the estimator can not attribute the correct amount of variance each regressor accounts for <code class="docutils literal notranslate"><span class="pre">Y</span></code> and the coefficients can become unstable. A more intuitive depiction of this problem can be seen in the venn diagram. The dark orange area in the center at the confluence of all 3 circles reflects the shared variance between <code class="docutils literal notranslate"><span class="pre">X1</span></code> and <code class="docutils literal notranslate"><span class="pre">X2</span></code> on <code class="docutils literal notranslate"><span class="pre">Y</span></code>. If this area becomes bigger, the unique variances become smaller and individually reflect less of the total variance on <code class="docutils literal notranslate"><span class="pre">Y</span></code>.</p>
<p><img alt="MultipleRegression.png" src="../_images/MultipleRegression.png" /></p>
<p>One way to evaluate multicollinearity is to examine the pairwise correlations between each regressor. We plot the correlation matrix as a heatmap.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">dm_conv</span><span class="o">.</span><span class="n">corr</span><span class="p">(),</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7fb700e335d0&gt;
</pre></div>
</div>
<img alt="../_images/8adee58675b89e389ddfe43d3f49fd2e4d7343beab084ad820c86223f051e660.png" src="../_images/8adee58675b89e389ddfe43d3f49fd2e4d7343beab084ad820c86223f051e660.png" />
</div>
</div>
<section id="variance-inflation-factor">
<h4>Variance Inflation Factor<a class="headerlink" href="#variance-inflation-factor" title="Permalink to this heading">#</a></h4>
<p>Pairwise correlations will let you know if any regressor is correlated with another regressor. However, we are even more concerned about being able to explain any regressor as a linear combination of the other regressors. For example, <em>can one regressor be explained by three or more of the remaining regressors?</em> The variance inflation factor (VIF) is a metric that can help us detect multicollinearity. Specifically, it is simply the ratio of variance in a model with multiple terms, divided by the variance of a model with only a single term. This ratio reduces to the following formula:</p>
<div class="math notranslate nohighlight">
\[VIF_j=\frac{1}{1-R_i^2}\]</div>
<p>Where <span class="math notranslate nohighlight">\(R_j^2\)</span> is the <span class="math notranslate nohighlight">\(R^2\)</span> value obtained by regressing the <span class="math notranslate nohighlight">\(jth\)</span> predictor on the remaining predictors. This means that each regressor <span class="math notranslate nohighlight">\(j\)</span> will have it’s own variance inflation factor.</p>
<p>How should we interpret the VIF values?</p>
<p>A VIF of 1 indicates that there is no correlation among the <span class="math notranslate nohighlight">\(jth\)</span> predictor and the remaining variables. Values greater than 4 should be investigated further, while VIFs exceeding 10 indicate significant multicollinearity and will likely require intervention.</p>
<p>Here we will use the <code class="docutils literal notranslate"><span class="pre">.vif()</span></code> method to calculate the variance inflation factor for our design matrix.</p>
<p>See this <a class="reference external" href="https://online.stat.psu.edu/stat501/lesson/12/12.4">overview</a> for more details on VIFs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dm_conv</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">dm_conv</span><span class="o">.</span><span class="n">vif</span><span class="p">(),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Variance Inflation Factor&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;Variance Inflation Factor&#39;)
</pre></div>
</div>
<img alt="../_images/0d2b98f1a13dbb99eede3dde12a0e7ca961675c8baf7efc4ea8197c39a27bcab.png" src="../_images/0d2b98f1a13dbb99eede3dde12a0e7ca961675c8baf7efc4ea8197c39a27bcab.png" />
</div>
</div>
</section>
<section id="orthogonalization">
<h4>Orthogonalization<a class="headerlink" href="#orthogonalization" title="Permalink to this heading">#</a></h4>
<p>There are many ways to deal with collinearity. In practice, don’t worry about collinearity between your covariates. The more pernicious issues are collinearity in your experimental design.</p>
<p>It is commonly thought that using a procedure called orthogonalization should be used to address issues of multicollinearity. In linear algebra, orthogonalization is the process of prioritizing shared variance between regressors to a single regressor. Recall that the standard GLM already accounts for shared variance by removing it from individual regressors. Orthogonalization allows a user to assign that variance to a specific regressor. However, the process of performing this procedure can introduce artifact into the model and often changes the interpretation of the beta weights in unanticipated ways.</p>
<p><img alt="Orthogonalization.png" src="../_images/Orthogonalization.png" /></p>
<p>In general, we do not recommend using orthogonalization in most use cases, with the exception of centering regressor variables. We encourage the interested reader to review this very useful <a class="reference external" href="https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0126255">overview</a> of collinearity and orthogonalization by Jeanette Mumford and colleagues.</p>
</section>
</section>
</section>
<section id="nuisance-variables">
<h2>Nuisance Variables<a class="headerlink" href="#nuisance-variables" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">YouTubeVideo</span>

<span class="n">YouTubeVideo</span><span class="p">(</span><span class="s1">&#39;DEtwsFdFwYc&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="400"
            height="300"
            src="https://www.youtube.com/embed/DEtwsFdFwYc"
            frameborder="0"
            allowfullscreen
        ></iframe>
        </div></div>
</div>
<section id="filtering">
<h3>Filtering<a class="headerlink" href="#filtering" title="Permalink to this heading">#</a></h3>
<p>Recall from our signal processing tutorial, that there are often other types of artifacts in our signal that might take the form of slow or fast oscillations. It is common to apply a high pass filter to the data to remove low frequency artifacts. Often this can also be addressed by simply using a few polynomials to model these types of trends. If we were to directly filter the brain data using something like a butterworth filter as we did in our signal processing tutorial, we would also need to apply it to our design matrix to make sure that we don’t have any low frequency drift in experimental design. One easy way to simultaneously perform both of these procedures is to simply build a filter into the design matrix. We will be using a discrete cosine transform (DCT), which is a basis set of cosine regressors of varying frequencies up to a filter cutoff of a specified number of seconds. Many software use 100s or 128s as a default cutoff, but we encourage caution that the filter cutoff isn’t too short for your specific experimental design. Longer trials will require longer filter cutoffs. See this <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S1053811900906098">paper</a> for a more technical treatment of using the DCT as a high pass filter in fMRI data analysis. In addition, here is a more detailed discussion about <a class="reference external" href="https://web.archive.org/web/20200224000649/http://mindhive.mit.edu/node/116">filtering</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dm_conv_filt</span> <span class="o">=</span> <span class="n">dm_conv</span><span class="o">.</span><span class="n">add_dct_basis</span><span class="p">(</span><span class="n">duration</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dm_conv_filt</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">10</span><span class="p">:]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7fb69095e390&gt;
</pre></div>
</div>
<img alt="../_images/1f5486c086683894b8a9c25557a7b4663af1e182452e62eccab73a92577d3ad3.png" src="../_images/1f5486c086683894b8a9c25557a7b4663af1e182452e62eccab73a92577d3ad3.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dm_conv_filt</span> <span class="o">=</span> <span class="n">dm_conv</span><span class="o">.</span><span class="n">add_dct_basis</span><span class="p">(</span><span class="n">duration</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="n">dm_conv_filt</span><span class="o">.</span><span class="n">heatmap</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/796f036252d14083ba22ef8ff79ea6a2a57e759182deb2a4651eae53d778b968.png" src="../_images/796f036252d14083ba22ef8ff79ea6a2a57e759182deb2a4651eae53d778b968.png" />
</div>
</div>
</section>
<section id="intercepts">
<h3>Intercepts<a class="headerlink" href="#intercepts" title="Permalink to this heading">#</a></h3>
<p>We almost always want to include an intercept in our model. This will usually reflect the baseline, or the average voxel response during the times that are not being modeled as a regressor. It is important to note that you must have some sparsity to your model, meaning that you can’t model every point in time, as this will make your model rank deficient and unestimable.</p>
<p>If you are concatenating runs and modeling them all together, it is recommended to include a separate intercept for each run, but not for the entire model. This means that the average response within a voxel might differ across runs. You can add an intercept by simply creating a new column of ones (e.g., <code class="docutils literal notranslate"><span class="pre">dm['Intercept]</span> <span class="pre">=</span> <span class="pre">1</span></code>). Here we provide an example using the <code class="docutils literal notranslate"><span class="pre">.add_poly()</span></code> method, which adds an intercept by default.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dm_conv_filt_poly</span> <span class="o">=</span> <span class="n">dm_conv_filt</span><span class="o">.</span><span class="n">add_poly</span><span class="p">()</span>
<span class="n">dm_conv_filt_poly</span><span class="o">.</span><span class="n">heatmap</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/7e4bf11ebb855863e11b38b2a88a88356b50b4f9ba1bc2dd9dc17a88bdb62d27.png" src="../_images/7e4bf11ebb855863e11b38b2a88a88356b50b4f9ba1bc2dd9dc17a88bdb62d27.png" />
</div>
</div>
</section>
<section id="linear-trends">
<h3>Linear Trends<a class="headerlink" href="#linear-trends" title="Permalink to this heading">#</a></h3>
<p>We also often want to remove any slow drifts in our data.  This might include a linear trend and a quadratic trend. We can also do this with the <code class="docutils literal notranslate"><span class="pre">.add_poly()</span></code> method and adding all trends up to an order of 2 (e.g., quadratic). We typically use this approach rather than applying a high pass filter when working with naturalistic viewing data.</p>
<p>Notice that these do not appear to be very different from the high pass filter basis set. It’s actually okay if there is collinearity in our covariate regressors. Collinearity is only a problem when it correlates with the task regressors as it means that we will not be able to uniquely model the variance. The DCT can occasionally run into edge artifacts, which can be addressed by the linear trend.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dm_conv_filt_poly</span> <span class="o">=</span> <span class="n">dm_conv_filt</span><span class="o">.</span><span class="n">add_poly</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">include_lower</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">dm_conv_filt_poly</span><span class="o">.</span><span class="n">heatmap</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/7e95a1c3fa3b6578342cc9c9eaef1eab0b1ad386723cae6bc269b4b1172206f0.png" src="../_images/7e95a1c3fa3b6578342cc9c9eaef1eab0b1ad386723cae6bc269b4b1172206f0.png" />
</div>
</div>
</section>
<section id="noise-covariates">
<h3>Noise Covariates<a class="headerlink" href="#noise-covariates" title="Permalink to this heading">#</a></h3>
<p>Another important thing to consider is removing variance associated with head motion. Remember the preprocessed data has already realigned each TR in space, but head motion itself can nonlinearly distort the magnetic field. There are several common strategies for trying to remove artifacts associated with head motion. One is using a data driven denoising algorithm like ICA and combining it with a classifer such as FSL’s <a class="reference external" href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FIX">FIX</a> module. Another approach is to include the amount of correction that needed to be applied to align each TR. For example, if someone moved a lot in a single TR, there will be a strong change in their realignment parameters. It is common to include the 6 parameters as covariates in your regression model. However, as we already noted, often motion can have a nonlinear relationship with signal intensity, so it is often good to include other transformations of these signals to capture nonlinear signal changes resulting from head motion. We typically center the six realigment parameters (or zscore) and then additionally add a quadratic version, a derivative, and the square of the derivatives, which becomes 24 additional regressors.</p>
<p>In addition, it is common to model out big changes using a regressor with a single value indicating the timepoint of the movement. This will be zeros along time, with a single value of one at the time point of interest. This effectively removes any variance associated with this single time point. It is important to model each “spike” as a separate regressor as there might be distinct spatial patterns associated with different types of head motions. We strongly recommond against using a single continuous frame displacement metric as is often recommended by the fMRIprep team. This assumes (1) that there is a <em>linear</em> relationship between displacement and voxel activity, and (2) that there is a <em>single</em> spatial generator or pattern associated with frame displacement. As we saw in the ICA noise lab, there might be many different types of head motion artifacts. This procedure of including spikes as nuisance regressors is mathematically equivalent to censoring your data and removing the bad TRs. We think it is important to do this in the context of the GLM as it will also reduce the impact if it happens to covary with your task.</p>
<p>First, let’s load preprocessed data from one participant.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sub</span> <span class="o">=</span> <span class="s1">&#39;S01&#39;</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">Brain_Data</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">sub</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="s1">&#39;localizer&#39;</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s1">&#39;derivatives&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s1">&#39;nii.gz&#39;</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s inspect the realignment parameters for this participant. These pertain to how much each volume had to be moved in the (X,Y,Z) planes and rotations around each axis. We are standardizing the data so that rotations and translations are on the same scale.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">covariates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="s1">&#39;S01&#39;</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s1">&#39;derivatives&#39;</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s1">&#39;.tsv&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">mc</span> <span class="o">=</span> <span class="n">covariates</span><span class="p">[[</span><span class="s1">&#39;trans_x&#39;</span><span class="p">,</span><span class="s1">&#39;trans_y&#39;</span><span class="p">,</span><span class="s1">&#39;trans_z&#39;</span><span class="p">,</span><span class="s1">&#39;rot_x&#39;</span><span class="p">,</span> <span class="s1">&#39;rot_y&#39;</span><span class="p">,</span> <span class="s1">&#39;rot_z&#39;</span><span class="p">]]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">zscore</span><span class="p">(</span><span class="n">mc</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x7fb68b61c190&gt;,
 &lt;matplotlib.lines.Line2D at 0x7fb68b61cd10&gt;,
 &lt;matplotlib.lines.Line2D at 0x7fb68b61c390&gt;,
 &lt;matplotlib.lines.Line2D at 0x7fb68b61c110&gt;,
 &lt;matplotlib.lines.Line2D at 0x7fb68b61cc50&gt;,
 &lt;matplotlib.lines.Line2D at 0x7fb68b61c290&gt;]
</pre></div>
</div>
<img alt="../_images/8c84e382f4bae945f8459af71b4603a1663a2caac8bdf04965f19848ab171e9b.png" src="../_images/8c84e382f4bae945f8459af71b4603a1663a2caac8bdf04965f19848ab171e9b.png" />
</div>
</div>
<p>Now, let’s build the 24 covariates related to head motion. We include the 6 realignment parameters that have been standardized. In addition, we add their quadratic, their derivative, and the square of their derivative.</p>
<p>We can create a quick visualization to see what the overall pattern is across the different regressors.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_motion_covariates</span><span class="p">(</span><span class="n">mc</span><span class="p">,</span> <span class="n">tr</span><span class="p">):</span>
    <span class="n">z_mc</span> <span class="o">=</span> <span class="n">zscore</span><span class="p">(</span><span class="n">mc</span><span class="p">)</span>
    <span class="n">all_mc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">z_mc</span><span class="p">,</span> <span class="n">z_mc</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">z_mc</span><span class="o">.</span><span class="n">diff</span><span class="p">(),</span> <span class="n">z_mc</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">all_mc</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Design_Matrix</span><span class="p">(</span><span class="n">all_mc</span><span class="p">,</span> <span class="n">sampling_freq</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">tr</span><span class="p">)</span>

<span class="n">tr</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">get_tr</span><span class="p">()</span>
<span class="n">mc_cov</span> <span class="o">=</span> <span class="n">make_motion_covariates</span><span class="p">(</span><span class="n">mc</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">mc_cov</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7fb68bb6d210&gt;
</pre></div>
</div>
<img alt="../_images/9571f0622ab6d94fbdc5f178fefbbbfe3abe762bcdec26c703a7e697ef70eb52.png" src="../_images/9571f0622ab6d94fbdc5f178fefbbbfe3abe762bcdec26c703a7e697ef70eb52.png" />
</div>
</div>
<p>Now let’s try to find some spikes in the data. This is performed by finding TRs that exceed a global mean threshold and also that exceed an overall average intensity change by a threshold.  We are using an arbitrary cutoff of 3 standard deviations as a threshold.</p>
<p>First, let’s plot the average signal intensity across all voxels over time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;Intensity&#39;)
</pre></div>
</div>
<img alt="../_images/aed016f47fd3ae313d51fda940cdb15d4b8631f767a92ff9716630c957986b5f.png" src="../_images/aed016f47fd3ae313d51fda940cdb15d4b8631f767a92ff9716630c957986b5f.png" />
</div>
</div>
<p>Notice there is a clear slow drift in the signal that we will need to remove with our high pass filter.</p>
<p>Now, let’s see if there are any spikes in the data that exceed our threshold. What happens if we use a different threshold?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spikes</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">find_spikes</span><span class="p">(</span><span class="n">global_spike_cutoff</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">diff_spike_cutoff</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>

<span class="n">f</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">spikes</span> <span class="o">=</span> <span class="n">Design_Matrix</span><span class="p">(</span><span class="n">spikes</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:],</span> <span class="n">sampling_freq</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">tr</span><span class="p">)</span>
<span class="n">spikes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">a</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7fb7010e7950&gt;
</pre></div>
</div>
<img alt="../_images/78e1f5313d9fddd49ff1922820be3751cd5cb61903f874159a38525be99f9345.png" src="../_images/78e1f5313d9fddd49ff1922820be3751cd5cb61903f874159a38525be99f9345.png" />
</div>
</div>
<p>For this subject, our spike identification procedure identified 3 spikes. Two of these spikes look like they are temporally contiguous. Let’s add all of these covariate to our design matrix.</p>
<p>In this example, we will append each of these additional matrices to our main design matrix.</p>
<p><strong>Note</strong>: <code class="docutils literal notranslate"><span class="pre">.append()</span></code> requires that all matrices are a design_matrix with the same sampling frequency.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dm_conv_filt_poly_cov</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dm_conv_filt_poly</span><span class="p">,</span> <span class="n">mc_cov</span><span class="p">,</span> <span class="n">spikes</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">dm_conv_filt_poly_cov</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ff3a35c36800733fd2876fa4b80b37698fd94a223787f22aa765e53a62f487af.png" src="../_images/ff3a35c36800733fd2876fa4b80b37698fd94a223787f22aa765e53a62f487af.png" />
</div>
</div>
</section>
</section>
<section id="smoothing">
<h2>Smoothing<a class="headerlink" href="#smoothing" title="Permalink to this heading">#</a></h2>
<p>To increase the signal to noise ratio and clean up the data, it is common to apply spatial smoothing to the image.</p>
<p>Here we will convolve the image with a 3-D gaussian kernel, with a 6mm full width half maximum (FWHM) using the <code class="docutils literal notranslate"><span class="pre">.smooth()</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fwhm</span><span class="o">=</span><span class="mi">6</span>
<span class="n">smoothed</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">fwhm</span><span class="o">=</span><span class="n">fwhm</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s take a look and see how this changes the image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>threshold is ignored for simple axial plots
</pre></div>
</div>
<img alt="../_images/6906f562c75dd8499143a577917aceb3db0132adcd9fe7d8bc641fcaddebbc5f.png" src="../_images/6906f562c75dd8499143a577917aceb3db0132adcd9fe7d8bc641fcaddebbc5f.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">smoothed</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>threshold is ignored for simple axial plots
</pre></div>
</div>
<img alt="../_images/57b6b253341d3f27be65d74cf07a11d37b0f0e7847395ec6ddd54acdaee848ac.png" src="../_images/57b6b253341d3f27be65d74cf07a11d37b0f0e7847395ec6ddd54acdaee848ac.png" />
</div>
</div>
</section>
<section id="estimate-glm-for-all-voxels">
<h2>Estimate GLM for all voxels<a class="headerlink" href="#estimate-glm-for-all-voxels" title="Permalink to this heading">#</a></h2>
<p>Now we are ready to estimate the regression model for all voxels.</p>
<p>We will assign the design_matrix object to the <code class="docutils literal notranslate"><span class="pre">.X</span></code> attribute of our <code class="docutils literal notranslate"><span class="pre">Brain_Data</span></code> instance.</p>
<p>Then we simply need to run the <code class="docutils literal notranslate"><span class="pre">.regress()</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">smoothed</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">dm_conv_filt_poly_cov</span>
<span class="n">stats</span> <span class="o">=</span> <span class="n">smoothed</span><span class="o">.</span><span class="n">regress</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dict_keys([&#39;beta&#39;, &#39;t&#39;, &#39;p&#39;, &#39;sigma&#39;, &#39;residual&#39;])
</pre></div>
</div>
</div>
</div>
<p>Ok, it’s done! Let’s take a look at the results.</p>
<p>The stats variable is a dictionary with the main results from the regression: a brain image with all of the betas for each voxel, a correspondign image of t-values, p-values, standard error of the estimate, and residuals.</p>
<p>Remember we have run the same regression model separately on each voxel of the brain.</p>
<p>Let’s take a look at one of the regressors. The names of each of them are in the column names of the design matrix, which is in the <code class="docutils literal notranslate"><span class="pre">data.X</span></code> field.  We can print them to see the names. Let’s plot the first one, which corresponds to <code class="docutils literal notranslate"><span class="pre">video_computation_c0</span></code> or an arithmetic problem presented in the visual domain.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">smoothed</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;video_computation_c0&#39;, &#39;horizontal_checkerboard_c0&#39;,
       &#39;audio_right_hand_c0&#39;, &#39;audio_sentence_c0&#39;, &#39;video_right_hand_c0&#39;,
       &#39;audio_left_hand_c0&#39;, &#39;video_left_hand_c0&#39;, &#39;vertical_checkerboard_c0&#39;,
       &#39;audio_computation_c0&#39;, &#39;video_sentence_c0&#39;, &#39;cosine_1&#39;, &#39;cosine_2&#39;,
       &#39;cosine_3&#39;, &#39;cosine_4&#39;, &#39;poly_0&#39;, &#39;poly_1&#39;, &#39;poly_2&#39;, &#39;poly_3&#39;,
       &#39;trans_x&#39;, &#39;trans_y&#39;, &#39;trans_z&#39;, &#39;rot_x&#39;, &#39;rot_y&#39;, &#39;rot_z&#39;, &#39;trans_x&#39;,
       &#39;trans_y&#39;, &#39;trans_z&#39;, &#39;rot_x&#39;, &#39;rot_y&#39;, &#39;rot_z&#39;, &#39;trans_x&#39;, &#39;trans_y&#39;,
       &#39;trans_z&#39;, &#39;rot_x&#39;, &#39;rot_y&#39;, &#39;rot_z&#39;, &#39;trans_x&#39;, &#39;trans_y&#39;, &#39;trans_z&#39;,
       &#39;rot_x&#39;, &#39;rot_y&#39;, &#39;rot_z&#39;, &#39;diff_spike1&#39;, &#39;diff_spike2&#39;, &#39;diff_spike3&#39;],
      dtype=&#39;object&#39;)
</pre></div>
</div>
</div>
</div>
<p>Brain_Data instances have their own plotting methods. We will be using <code class="docutils literal notranslate"><span class="pre">.iplot()</span></code> here, which can allow us to interactively look at all of the values.</p>
<p>If you would like to see the top values, we can quickly apply a threshold. Try using <code class="docutils literal notranslate"><span class="pre">95</span></code>% threshold, and be sure to click the <code class="docutils literal notranslate"><span class="pre">percentile_threshold</span></code> option.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">iplot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "6f91755cf56e4335a11b7ee33eb0bd0a", "version_major": 2, "version_minor": 0}</script></div>
</div>
<section id="save-image">
<h3>Save Image<a class="headerlink" href="#save-image" title="Permalink to this heading">#</a></h3>
<p>We will frequently want to save different brain images we are working with to a nifti file. This is useful for saving intermediate work, or sharing our results with others. This is easy with the <code class="docutils literal notranslate"><span class="pre">.write()</span></code> method. Be sure to specify a path and file name for the file.</p>
<p><strong>Note</strong>: You can only write to folders where you have permission. Try changing the path to your own directory.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">smoothed</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_betas_denoised_smoothed</span><span class="si">{</span><span class="n">fwhm</span><span class="si">}</span><span class="s1">_preprocessed_fMRI_bold.nii.gz&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="contrasts">
<h2>Contrasts<a class="headerlink" href="#contrasts" title="Permalink to this heading">#</a></h2>
<p>Now that we have estimated our model, we will likely want to create contrasts to examine brain activation to different conditions.</p>
<p>This procedure is identical to those introduced in our GLM tutorial.</p>
<p>Let’s watch another video by Tor Wager to better understand contrasts at the first-level model stage.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">YouTubeVideo</span><span class="p">(</span><span class="s1">&#39;7MibM1ATai4&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="400"
            height="300"
            src="https://www.youtube.com/embed/7MibM1ATai4"
            frameborder="0"
            allowfullscreen
        ></iframe>
        </div></div>
</div>
<p>Now, let’s try making a simple contrast where we average only the regressors pertaining to motor. This is essentially summing all of the motor regressors. To take the mean we need to divide by the number of regressors.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">smoothed</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

<span class="n">c1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]))</span>
<span class="n">c1</span><span class="p">[[</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">4</span>
<span class="nb">print</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>

<span class="n">motor</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">c1</span>

<span class="n">motor</span><span class="o">.</span><span class="n">iplot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;video_computation_c0&#39;, &#39;horizontal_checkerboard_c0&#39;,
       &#39;audio_right_hand_c0&#39;, &#39;audio_sentence_c0&#39;, &#39;video_right_hand_c0&#39;,
       &#39;audio_left_hand_c0&#39;, &#39;video_left_hand_c0&#39;, &#39;vertical_checkerboard_c0&#39;,
       &#39;audio_computation_c0&#39;, &#39;video_sentence_c0&#39;, &#39;cosine_1&#39;, &#39;cosine_2&#39;,
       &#39;cosine_3&#39;, &#39;cosine_4&#39;, &#39;poly_0&#39;, &#39;poly_1&#39;, &#39;poly_2&#39;, &#39;poly_3&#39;,
       &#39;trans_x&#39;, &#39;trans_y&#39;, &#39;trans_z&#39;, &#39;rot_x&#39;, &#39;rot_y&#39;, &#39;rot_z&#39;, &#39;trans_x&#39;,
       &#39;trans_y&#39;, &#39;trans_z&#39;, &#39;rot_x&#39;, &#39;rot_y&#39;, &#39;rot_z&#39;, &#39;trans_x&#39;, &#39;trans_y&#39;,
       &#39;trans_z&#39;, &#39;rot_x&#39;, &#39;rot_y&#39;, &#39;rot_z&#39;, &#39;trans_x&#39;, &#39;trans_y&#39;, &#39;trans_z&#39;,
       &#39;rot_x&#39;, &#39;rot_y&#39;, &#39;rot_z&#39;, &#39;diff_spike1&#39;, &#39;diff_spike2&#39;, &#39;diff_spike3&#39;],
      dtype=&#39;object&#39;)
[0.   0.   0.25 0.   0.25 0.25 0.25 0.   0.   0.   0.   0.   0.   0.
 0.   0.   0.   0.   0.   0.   0.   0.   0.   0.   0.   0.   0.   0.
 0.   0.   0.   0.   0.   0.   0.   0.   0.   0.   0.   0.   0.   0.
 0.   0.   0.  ]
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "8cf0fee0774c4fd29aac5d461145ea80", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>Ok, now we can clearly see regions specifically involved in motor processing.</p>
<p>Now let’s see which regions are more active when making motor movements with our right hand compared to our left hand.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c_rvl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]))</span>
<span class="n">c_rvl</span><span class="p">[[</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">.5</span><span class="p">,</span> <span class="mf">.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">.5</span><span class="p">]</span>

<span class="n">motor_rvl</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">c_rvl</span>

<span class="n">motor_rvl</span><span class="o">.</span><span class="n">iplot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "a882fb737d0a41ebb1766f348ae75200", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>What do you see?</p>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Permalink to this heading">#</a></h2>
<p>For homework, let’s get a better handle on how to play with our data and test different hypotheses.</p>
<section id="which-regions-are-more-involved-with-visual-compared-to-auditory-sensory-processing">
<h3>1. Which regions are more involved with visual compared to auditory sensory processing?<a class="headerlink" href="#which-regions-are-more-involved-with-visual-compared-to-auditory-sensory-processing" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Create a contrast to test this hypothesis</p></li>
<li><p>plot the results</p></li>
<li><p>write the file to your output folder.</p></li>
</ul>
</section>
<section id="which-regions-are-more-involved-in-processing-numbers-compared-to-words">
<h3>2. Which regions are more involved in processing numbers compared to words?<a class="headerlink" href="#which-regions-are-more-involved-in-processing-numbers-compared-to-words" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Create a contrast to test this hypothesis</p></li>
<li><p>plot the results</p></li>
<li><p>write the file to your output folder.</p></li>
</ul>
</section>
<section id="which-regions-are-more-involved-with-motor-compared-to-cognitive-processes-e-g-language-and-math">
<h3>3. Which regions are more involved with motor compared to cognitive processes (e.g., language and math)?<a class="headerlink" href="#which-regions-are-more-involved-with-motor-compared-to-cognitive-processes-e-g-language-and-math" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Create a contrast to test this hypothesis</p></li>
<li><p>plot the results</p></li>
<li><p>write the file to your output folder.</p></li>
</ul>
</section>
<section id="how-are-your-results-impacted-by-different-smoothing-kernels">
<h3>4. How are your results impacted by different smoothing kernels?<a class="headerlink" href="#how-are-your-results-impacted-by-different-smoothing-kernels" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Pick two different sized smoothing kernels and create two new brain images with each smoothing kernel</p></li>
<li><p>Pick any contrast of interest to you and evaluate the impact of smoothing on the contrast.</p></li>
<li><p>plot the results</p></li>
<li><p>write the file to your output folder.</p></li>
</ul>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "mpcoll/psy7000v2",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./content"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dataset">Dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#building-a-design-matrix">Building a Design Matrix</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hrf-convolution">HRF Convolution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multicollinearity">Multicollinearity</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#variance-inflation-factor">Variance Inflation Factor</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#orthogonalization">Orthogonalization</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nuisance-variables">Nuisance Variables</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#filtering">Filtering</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#intercepts">Intercepts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#linear-trends">Linear Trends</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#noise-covariates">Noise Covariates</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#smoothing">Smoothing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#estimate-glm-for-all-voxels">Estimate GLM for all voxels</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#save-image">Save Image</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#contrasts">Contrasts</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#which-regions-are-more-involved-with-visual-compared-to-auditory-sensory-processing">1. Which regions are more involved with visual compared to auditory sensory processing?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#which-regions-are-more-involved-in-processing-numbers-compared-to-words">2. Which regions are more involved in processing numbers compared to words?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#which-regions-are-more-involved-with-motor-compared-to-cognitive-processes-e-g-language-and-math">3. Which regions are more involved with motor compared to cognitive processes (e.g., language and math)?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-are-your-results-impacted-by-different-smoothing-kernels">4. How are your results impacted by different smoothing kernels?</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Michel-Pierre Coll
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  Projet supporté par le <a href='https://www.enseigner.ulaval.ca/appui-a-l-innovation/programme-d-appui-l-innovation-pedagogique'>Programme d'appui à l'innovation pédagogique de l'Université Laval</a> <img src="images/logo/ulavallogo.png">.
</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>